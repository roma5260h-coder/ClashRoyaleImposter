import re
from typing import Dict, Optional

# Карта -> стоимость эликсира. None означает «—» (не показываем бейдж).
ELIXIR_COSTS: Dict[str, Optional[int]] = {
    "Лучницы": 3,
    "Дракончик": 4,
    "Шар": 5,
    "Бандитка": 3,
    "Варвары": 5,
    "Летучие мыши": 2,
    "Целительница-воин": 4,
    "Боевой таран": 4,
    "Подрывник": 2,
    "Вышибала": 5,
    "Повозка с пушкой": 5,
    "Повозка с пушкой (без повозки)": 5,
    "Заколдованный кабан": None,
    "Тёмный принц": 4,
    "Гоблин с дротиками": 3,
    "Электродракон": 5,
    "Электрогигант": 7,
    "Громовержец": 4,
    "Элитные варвары": 6,
    "Эликсирный голем": 3,
    "Эликсирный големчик": None,
    "Капля эликсира": None,
    "Палач": 5,
    "Огненная лучница": 3,
    "Огненный дух": 1,
    "Рыбак": 3,
    "Летучка": 4,
    "Гигант": 5,
    "Гигантский скелет": 6,
    "Гоблин-громила": 4,
    "Банда гоблинов": 3,
    "Гоблин-гигант": 6,
    "Гоблины": 2,
    "Голем": 8,
    "Големчики": None,
    "Стражи": 3,
    "Всадник на кабане": 4,
    "Охотник": 4,
    "Дух исцеления": 1,
    "Ледяной голем": 2,
    "Ледяной дух": 1,
    "Ледяной колдун": 3,
    "Пламенный дракон": 4,
    "Рыцарь": 3,
    "Адская гончая": 7,
    "Адский щенок": None,
    "Дровосек": 4,
    "Магический лучник": 4,
    "Мегаминьон": 3,
    "Мегарыцарь": 7,
    "Мини-П.Е.К.К.А.": 4,
    "Шахтёр": 3,
    "Миньоны": 3,
    "Орда миньонов": 5,
    "Ведьмина бабушка": 4,
    "Мушкетёр": 4,
    "Ночная ведьма": 4,
    "П.Е.К.К.А.": 7,
    "Принц": 5,
    "Принцесса": 3,
    "Всадница на баране": 5,
    "Парень-разбойник": 5,
    "Девушка-разбойница": 5,
    "Королевский призрак": 3,
    "Королевский гигант": 6,
    "Королевские кабаны": 5,
    "Королевские рекруты": 7,
    "Скелеты": 1,
    "Армия скелетов": 3,
    "Бочка со скелетами": 3,
    "Костяные драконы": 4,
    "Спарки": 6,
    "Гоблины-копейщики": 2,
    "Три мушкетёра": 9,
    "Валькирия": 4,
    "Стенобои": 2,
    "Ведьма": 5,
    "Колдун": 5,
    "Минигенераторы": 4,
    "Мини-генераторы": 4,
    "Разбойники": 5,

    # Атакующие здания
    "Башня-бомбёжка": 4,
    "Пушка": 3,
    "Адская башня": 5,
    "Мортира": 4,
    "Тесла": 4,
    "Арбалет": 6,

    # Пассивные здания
    "Хижина варваров": 6,
    "Сборщик эликсира": 6,
    "Печь": 4,
    "Клетка с гоблином": 4,
    "Гоблинский бур": 4,
    "Хижина гоблинов": 5,
    "Надгробие": 3,

    # Заклинания
    "Стрелы": 3,
    "Варварская бочка": 2,
    "Землетрясение": 3,
    "Огненный шар": 4,
    "Заморозка": 4,
    "Гигантский снежок": 2,
    "Молния": 6,
    "Яд": 4,
    "Ракета": 6,
    "Королевская почта": 3,
    "Бревно": 2,
    "Торнадо": 3,
    "Разряд": 2,

    # Призыватели
    "Гоблинская бочка": 3,
    "Кладбище": 5,
}

_LOWER_COSTS = {k.lower(): v for k, v in ELIXIR_COSTS.items()}
_NORMALIZED_COSTS = {}
_MISSING_COSTS = set()


def _normalize(name: str) -> str:
    value = name.lower().strip().replace("ё", "е")
    value = re.sub(r"\s+", " ", value)
    value = re.sub(r"[\s\-—–\.·_]+", "", value)
    value = re.sub(r"[()\[\]]", "", value)
    return value


def _build_normalized() -> None:
    if _NORMALIZED_COSTS:
        return
    for key, cost in ELIXIR_COSTS.items():
        _NORMALIZED_COSTS[_normalize(key)] = cost


def get_elixir_cost(card_name: Optional[str]) -> Optional[int]:
    if not card_name:
        return None
    _build_normalized()
    raw = card_name.strip()
    lower = raw.lower()
    if lower in _LOWER_COSTS:
        return _LOWER_COSTS[lower]

    normalized = _normalize(raw)
    if normalized in _NORMALIZED_COSTS:
        return _NORMALIZED_COSTS[normalized]

    # Попробуем убрать уточнение в скобках
    base = re.sub(r"\s*\(.*\)$", "", raw).strip()
    if base and base != raw:
        base_lower = base.lower()
        if base_lower in _LOWER_COSTS:
            return _LOWER_COSTS[base_lower]
        base_norm = _normalize(base)
        if base_norm in _NORMALIZED_COSTS:
            return _NORMALIZED_COSTS[base_norm]

    # Небольшие keyword-алиасы
    if "разбойник" in normalized:
        return 5

    if raw not in _MISSING_COSTS:
        _MISSING_COSTS.add(raw)
        print(f"[ELIXIR] Cost not found for: {raw}")
    return None
